{
  "properties": {
    "connectionReferences": {
      "shared_commondataservice_3": {
        "api": {
          "name": "shared_commondataservice"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseLegacy"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps_1": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerplatformforadmins": {
        "api": {
          "name": "shared_powerplatformforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Check_if_Dataverse_Environment,_If_false,_terminate": {
          "actions": {
            "Not_a_Dataverse_Environment_=_no_Model_Driven_Apps": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "cf0ce42a-3083-4ae7-9931-729101ecce5c"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_hascds']",
              "@false"
            ]
          },
          "metadata": {
            "operationMetadataId": "55f33f40-860b-40c1-8ba1-5a3fb8a2b9db"
          },
          "runAfter": {
            "Check_if_Environment_Deleted._If_true,_terminate": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Dev_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Dev_SKU": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "f1ecf3b8-1772-4437-beb2-0663a3f4d5b0"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Developer"
            ]
          },
          "metadata": {
            "operationMetadataId": "53d63d2d-7eda-4941-8a45-9cac3ddfdc81"
          },
          "runAfter": {
            "Check_if_Dataverse_Environment,_If_false,_terminate": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Environment_Deleted._If_true,_terminate": {
          "actions": {
            "Terminate": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "47f3f378-de44-463f-986f-128468a1a363"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentdeleted']",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "eb2ec862-ebc6-4814-9d4a-17fc5db0d4b5"
          },
          "runAfter": {},
          "type": "If"
        },
        "Check_if_Teams_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Teams_SKU": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "0833ccaf-2acb-4c9f-bcd0-5c610ce2d5db"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Teams"
            ]
          },
          "metadata": {
            "operationMetadataId": "1dc55cc3-de87-458c-8a63-c9500333dfcf"
          },
          "runAfter": {
            "Check_if_Dev_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_to_see_if_portal_Model_Driven_App_Exists._Store_in_Portal_COE_Entity": {
          "actions": {
            "Get_Environment_as_Admin": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins",
                  "connectionName": "shared_powerplatformforadmins",
                  "operationId": "GetSingleEnvironment"
                },
                "parameters": {
                  "api-version": "2018-10-01",
                  "environment": "@triggerOutputs()?['body/admin_environmentname']"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "788b7d74-36b9-4608-bb4a-a56abd359854"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Loop_Through_each_website_record": {
              "actions": {
                "Data_Security_": {
                  "actions": {
                    "All_Table_Permissions_Enbabled": {
                      "inputs": "@if(and(variables('AdvancedFormStepHasTablePermissionsEnabled'), outputs('Basic_Form_Table_Permission_Enabled_Value_'), outputs('Entity_List_Table_Permission_Enabled_Value')), true, false)",
                      "metadata": {
                        "operationMetadataId": "a89daeda-14ac-45b2-9f1f-f990fef194f2"
                      },
                      "runAfter": {
                        "Apply_to_each_Advanced_Form": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Apply_to_each_Advanced_Form": {
                      "actions": {
                        "AdvancedFormID": {
                          "inputs": "@items('Apply_to_each_Advanced_Form')?['adx_webformid']",
                          "metadata": {
                            "operationMetadataId": "cd606b33-7ed7-43af-92fd-8afe0bf9e94f"
                          },
                          "runAfter": {},
                          "type": "Compose"
                        },
                        "If_found_steps_with_permissions_disabled,_set_the_variable_to_true": {
                          "actions": {
                            "Set_AdvancedFormStepHasTablePermissionsEnabled_false": {
                              "inputs": {
                                "name": "AdvancedFormStepHasTablePermissionsEnabled",
                                "value": "@false"
                              },
                              "metadata": {
                                "operationMetadataId": "6a08d25e-b710-4e48-b0b0-767b57ac692c"
                              },
                              "runAfter": {},
                              "type": "SetVariable"
                            }
                          },
                          "expression": {
                            "greater": [
                              "@length(outputs('List_Related_Advanced_Form_Steps_with_Table_Permissions_Disabled')?['body/value'])",
                              0
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "47d2bf8e-6306-4ed5-96f6-4f7394de1295"
                          },
                          "runAfter": {
                            "List_Related_Advanced_Form_Steps_with_Table_Permissions_Disabled": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "List_Related_Advanced_Form_Steps_with_Table_Permissions_Disabled": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                              "connectionName": "shared_commondataservice_3",
                              "operationId": "GetItems_V2"
                            },
                            "parameters": {
                              "$filter": "_adx_webform_value eq @{outputs('AdvancedFormID')} and adx_entitypermissionsenabled eq false",
                              "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                              "table": "adx_webformsteps"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "6edccd2f-3743-4c46-ab8a-905233c5f8e5"
                          },
                          "runAfter": {
                            "AdvancedFormID": [
                              "Succeeded"
                            ]
                          },
                          "type": "OpenApiConnection"
                        }
                      },
                      "foreach": "@outputs('List_Related_Advanced_Forms')?['body/value']",
                      "metadata": {
                        "operationMetadataId": "9f377695-101e-40fe-b0ea-9badb2789920"
                      },
                      "runAfter": {
                        "List_Related_Advanced_Forms": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Basic_Form_Table_Permission_Enabled_Value_": {
                      "description": "If Returned entity list count <=0 then table permissions enabled = true. Else  table permissions =false.",
                      "inputs": "@if(equals(length(outputs('List_Related_Basic_Forms_with_Table_Permissions_Disabled')?['body/value']), 0), true, false)",
                      "metadata": {
                        "operationMetadataId": "9a845ea4-033e-4f4c-8131-8b164c6de28f"
                      },
                      "runAfter": {
                        "List_Related_Basic_Forms_with_Table_Permissions_Disabled": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Entity_List_Table_Permission_Enabled_Value": {
                      "description": "If Returned entity list count <=0 then table permissions enabled = true. Else  table permissions =false.",
                      "inputs": "@if(equals(length(outputs('List_Related_Entity_Lists_with_Table_Permissions_Disable')?['body/value']),0), true, false)",
                      "metadata": {
                        "operationMetadataId": "efdbba0b-7f6e-4f4e-b15e-0962b2f6c1f6"
                      },
                      "runAfter": {
                        "List_Related_Entity_Lists_with_Table_Permissions_Disable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "List_Related_Advanced_Forms": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice_3",
                          "operationId": "GetItems_V2"
                        },
                        "parameters": {
                          "$filter": "_adx_websiteid_value eq @{body('Parse_Portals_JSON')?['adx_websiteid']}",
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "table": "adx_webforms"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "cbd74439-692b-439f-aeb0-fe5c5a7d61be"
                      },
                      "runAfter": {
                        "Basic_Form_Table_Permission_Enabled_Value_": [
                          "Succeeded"
                        ]
                      },
                      "type": "OpenApiConnection"
                    },
                    "List_Related_Basic_Forms_with_Table_Permissions_Disabled": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice_3",
                          "operationId": "GetItems_V2"
                        },
                        "parameters": {
                          "$filter": "_adx_websiteid_value eq @{body('Parse_Portals_JSON')?['adx_websiteid']} and adx_entitypermissionsenabled eq false",
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "table": "adx_entityforms"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "e0770c34-2d66-4e93-8168-0f83b51bb398"
                      },
                      "runAfter": {
                        "Entity_List_Table_Permission_Enabled_Value": [
                          "Succeeded"
                        ]
                      },
                      "type": "OpenApiConnection"
                    },
                    "List_Related_Entity_Lists_with_Table_Permissions_Disable": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice_3",
                          "operationId": "GetItems_V2"
                        },
                        "parameters": {
                          "$filter": "_adx_websiteid_value eq @{body('Parse_Portals_JSON')?['adx_websiteid']} and adx_entitypermissionsenabled eq false",
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "table": "adx_entitylists"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "79cb9f07-7c8f-46e8-8723-16f23181ab9e"
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "41b56161-b45e-47c1-9b64-694b6a210cdc"
                  },
                  "runAfter": {
                    "Site_Settings_Filtering_for_Authentication_Types": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Get_the_owner_and_first_orphan_check": {
                  "actions": {
                    "Get_ADX_Website_Owner": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice_3",
                          "operationId": "GetItem_V2"
                        },
                        "parameters": {
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "id": "@body('Parse_Portals_JSON')?['_ownerid_value']",
                          "table": "systemusers"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "b43fecc9-2225-49cf-81bc-9a750b4d210e"
                      },
                      "runAfter": {
                        "Reset_isOrphaned_to_false": [
                          "Succeeded"
                        ]
                      },
                      "type": "OpenApiConnection"
                    },
                    "Get_Azure_AD_object_ID_column_for_system_user_table._See_if_Null": {
                      "actions": {
                        "Set_isOrphaned_to_true": {
                          "inputs": {
                            "name": "isOrphaned",
                            "value": "@true"
                          },
                          "metadata": {
                            "operationMetadataId": "a06045fe-7d68-4874-9cdb-7b598c39aad9"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "equals": [
                          "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']",
                          "@null"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "5d876715-594e-4203-b94f-ac3cebbc31a3"
                      },
                      "runAfter": {
                        "Get_ADX_Website_Owner": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Reset_isOrphaned_to_false": {
                      "inputs": {
                        "name": "isOrphaned",
                        "value": "@false"
                      },
                      "metadata": {
                        "operationMetadataId": "1c5692ad-5be6-430f-8c97-426131937249"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "be315490-e7b9-42e5-b393-08d608031906"
                  },
                  "runAfter": {
                    "UniqueNameString": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "If_did_not_return_rows_then_new_to_Coe_else_get_portal_GUID": {
                  "actions": {
                    "Set_isNewToCoEto_true": {
                      "inputs": {
                        "name": "isNewToCoE",
                        "value": "@true"
                      },
                      "metadata": {
                        "operationMetadataId": "a11bf54a-aeab-46f1-b4a1-38a07d55c336"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "PortalGUID": {
                        "description": "first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalid']",
                        "inputs": "@first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalid']",
                        "metadata": {
                          "operationMetadataId": "84de671f-0653-45cf-ad1b-e4547940e422"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      },
                      "PortalLastModified": {
                        "description": "first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalmodifiedon']",
                        "inputs": "@first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalmodifiedon']",
                        "metadata": {
                          "operationMetadataId": "91c85f61-5335-4b73-b97b-9b74c37c5ebd"
                        },
                        "runAfter": {
                          "PortalGUID": [
                            "Succeeded"
                          ]
                        },
                        "type": "Compose"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@length(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])",
                      0
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a0f9aeeb-49e2-4939-a400-d4c69ae8538c"
                  },
                  "runAfter": {
                    "List_Portals_that_match_by_Portal_Unique_Name": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "List_Portals_that_match_by_Portal_Unique_Name": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_portaluniquename eq '@{outputs('UniqueNameString')}'",
                      "$select": "admin_portalid, admin_portalmodifiedon",
                      "entityName": "admin_portals"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "1d7aaa7d-1b07-4819-b5bc-bf8fc330391f"
                  },
                  "runAfter": {
                    "Get_the_owner_and_first_orphan_check": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 5000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_Related_Site_Settings_to_the_portal": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                      "connectionName": "shared_commondataservice_3",
                      "operationId": "GetItems_V2"
                    },
                    "parameters": {
                      "$filter": "_adx_websiteid_value eq @{body('Parse_Portals_JSON')?['adx_websiteid']}",
                      "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                      "table": "adx_sitesettings"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "91d4f210-43d1-4ed4-998a-7148fce8c703"
                  },
                  "runAfter": {
                    "Parse_Portals_JSON": [
                      "Succeeded"
                    ]
                  },
                  "type": "OpenApiConnection"
                },
                "Parse_Portals_JSON": {
                  "inputs": {
                    "content": "@items('Loop_Through_each_website_record')",
                    "schema": {
                      "properties": {
                        "@@odata.etag": {
                          "type": "string"
                        },
                        "@@odata.id": {
                          "type": "string"
                        },
                        "ItemInternalId": {
                          "type": "string"
                        },
                        "_adx_defaultlanguage_type": {
                          "type": "string"
                        },
                        "_adx_defaultlanguage_value": {
                          "type": "string"
                        },
                        "_adx_footerwebtemplateid_type": {
                          "type": "string"
                        },
                        "_adx_footerwebtemplateid_value": {
                          "type": "string"
                        },
                        "_adx_headerwebtemplateid_type": {
                          "type": "string"
                        },
                        "_adx_headerwebtemplateid_value": {
                          "type": "string"
                        },
                        "_createdby_type": {
                          "type": "string"
                        },
                        "_createdby_value": {
                          "type": "string"
                        },
                        "_modifiedby_type": {
                          "type": "string"
                        },
                        "_modifiedby_value": {
                          "type": "string"
                        },
                        "_ownerid_type": {
                          "type": "string"
                        },
                        "_ownerid_value": {
                          "type": "string"
                        },
                        "_owningbusinessunit_type": {
                          "type": "string"
                        },
                        "_owningbusinessunit_value": {
                          "type": "string"
                        },
                        "_statecode_label": {
                          "type": "string"
                        },
                        "_statuscode_label": {
                          "type": "string"
                        },
                        "adx_name": {
                          "type": "string"
                        },
                        "adx_primarydomainname": {
                          "type": "string"
                        },
                        "adx_website_language": {
                          "type": "integer"
                        },
                        "adx_websiteid": {
                          "type": "string"
                        },
                        "createdon": {
                          "type": "string"
                        },
                        "modifiedon": {
                          "type": "string"
                        },
                        "statecode": {
                          "type": "integer"
                        },
                        "statuscode": {
                          "type": "integer"
                        },
                        "versionnumber": {
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "f26e29ca-cecf-41c6-be75-72268b84a29d"
                  },
                  "runAfter": {
                    "Reset_AdvancedFormStepHasTablePermissionsEnabled": [
                      "Succeeded"
                    ]
                  },
                  "type": "ParseJson"
                },
                "Reset_AdvancedFormStepHasTablePermissionsEnabled": {
                  "inputs": {
                    "name": "AdvancedFormStepHasTablePermissionsEnabled",
                    "value": "@true"
                  },
                  "metadata": {
                    "operationMetadataId": "6c91b1ac-21b5-443d-96dc-462199bf64f1"
                  },
                  "runAfter": {
                    "Reset_isNewToCOE": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Reset_isNewToCOE": {
                  "inputs": {
                    "name": "isNewToCoE",
                    "value": "@false"
                  },
                  "metadata": {
                    "operationMetadataId": "015935f0-ebf5-45d3-ad1f-c9bfa1ddd6b6"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "See_if_Portal_is_In_COE_Inventory_Table_(admin_portal)": {
                  "actions": {
                    "Only_Proceed_if_Changed_since_last_update_in_CoE_or_FullInventory": {
                      "actions": {
                        "Check_if_made_by_system": {
                          "actions": {
                            "Update_Portal_(created_by_SYSTEM)": {
                              "description": "Update if owned by the system",
                              "inputs": {
                                "authentication": "@parameters('$authentication')",
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "connectionName": "shared_commondataserviceforapps_1",
                                  "operationId": "UpdateRecord"
                                },
                                "parameters": {
                                  "entityName": "admin_portals",
                                  "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                  "item/admin_appownerdisplayname": "SYSTEM",
                                  "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                  "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                  "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                  "item/admin_authlocalregistrationenabled": "@outputs('Auth_Local_Registration_Enabled')",
                                  "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                  "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                  "item/admin_hasportalmanagementapp": true,
                                  "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                  "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                  "item/admin_portalisophaned": false,
                                  "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                  "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                  "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                  "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                  "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                  "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                  "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                  "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')",
                                  "recordId": "@outputs('PortalGUID')"
                                },
                                "retryPolicy": {
                                  "count": 10,
                                  "interval": "PT10S",
                                  "type": "exponential"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "adeb2003-ab71-4281-be8c-033e4423321e"
                              },
                              "runAfter": {},
                              "type": "OpenApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Recheck_Orphan_status": {
                                "actions": {
                                  "Check_if_Orphan_-_Edit": {
                                    "actions": {
                                      "Set_isOrphaned_true_on_recheck": {
                                        "inputs": {
                                          "name": "isOrphaned",
                                          "value": "@true"
                                        },
                                        "metadata": {
                                          "operationMetadataId": "9dd3d688-89a6-4ddf-aa9d-c24591ce1967"
                                        },
                                        "runAfter": {},
                                        "type": "SetVariable"
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "Set_isOrphaned_false_on_recheck": {
                                          "inputs": {
                                            "name": "isOrphaned",
                                            "value": "@false"
                                          },
                                          "metadata": {
                                            "operationMetadataId": "5325250c-5d5d-4a88-99e4-2f983d635640"
                                          },
                                          "runAfter": {},
                                          "type": "SetVariable"
                                        }
                                      }
                                    },
                                    "expression": {
                                      "equals": [
                                        "@body('Maker_Check_-_Edit')?['userisorphan']",
                                        "@true"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "176f0fc3-7c10-43c4-9849-edb310084959"
                                    },
                                    "runAfter": {
                                      "Maker_Check_-_Edit": [
                                        "Succeeded"
                                      ]
                                    },
                                    "type": "If"
                                  },
                                  "Maker_Check_-_Edit": {
                                    "inputs": {
                                      "body": {
                                        "boolean": false,
                                        "text": "@if(equals(body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid'], null), '', body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid'])",
                                        "text_1": "@body('Get_ADX_Website_Owner')?['fullname']"
                                      },
                                      "host": {
                                        "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "fe608dde-4375-4876-b0f4-1fbb8fde0cd3"
                                    },
                                    "runAfter": {},
                                    "type": "Workflow"
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "5e513f76-e5f4-4cfc-86cb-0906119016d8"
                                },
                                "runAfter": {},
                                "type": "If"
                              },
                              "Update_based_on_Orphan_Status": {
                                "actions": {
                                  "Update_Portal_Record": {
                                    "description": "Update if still owned by an AD user",
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps_1",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_portals",
                                        "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                        "item/admin_PortalOwner@odata.bind": "admin_makers(@{body('Maker_Check_-_Edit')?['userid']})",
                                        "item/admin_appownerdisplayname": "@body('Maker_Check_-_Edit')?['userdisplayname']",
                                        "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                        "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                        "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                        "item/admin_authlocalregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                        "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                        "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                        "item/admin_hasportalmanagementapp": true,
                                        "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                        "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                        "item/admin_portalisophaned": false,
                                        "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                        "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                        "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                        "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                        "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                        "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                        "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                        "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')",
                                        "recordId": "@outputs('PortalGUID')"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "83fc5c05-c228-4e9d-b2c6-f6385d02888c"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Update_Portal_Record_(Abandoned)": {
                                      "description": "Update if abandoned (user no longer in AD)",
                                      "inputs": {
                                        "authentication": "@parameters('$authentication')",
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "connectionName": "shared_commondataserviceforapps_1",
                                          "operationId": "UpdateRecord"
                                        },
                                        "parameters": {
                                          "entityName": "admin_portals",
                                          "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                          "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                          "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                          "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                          "item/admin_authlocalregistrationenabled": "@outputs('Auth_Local_Registration_Enabled')",
                                          "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                          "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                          "item/admin_hasportalmanagementapp": true,
                                          "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                          "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                          "item/admin_portalisophaned": true,
                                          "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                          "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                          "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                          "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                          "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                          "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                          "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                          "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')",
                                          "recordId": "@outputs('PortalGUID')"
                                        },
                                        "retryPolicy": {
                                          "count": 10,
                                          "interval": "PT10S",
                                          "type": "exponential"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "e4f0b886-353a-4e6c-9b0d-89ab49b3d6ac"
                                      },
                                      "runAfter": {},
                                      "type": "OpenApiConnection"
                                    }
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "4cf70157-c1be-4dcb-96c5-b2628c25758d"
                                },
                                "runAfter": {
                                  "Recheck_Orphan_status": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "If"
                              }
                            }
                          },
                          "expression": {
                            "equals": [
                              "@body('Get_ADX_Website_Owner')?['fullname']",
                              "SYSTEM"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "42f891cb-c2ee-485c-a44e-ef4bb6f49a54"
                          },
                          "runAfter": {},
                          "type": "If"
                        }
                      },
                      "expression": {
                        "or": [
                          {
                            "less": [
                              "@outputs('lastMod_from_COE')",
                              "@outputs('lastMod_from_Portal')"
                            ]
                          },
                          {
                            "equals": [
                              "@variables('fullInventory')",
                              "True"
                            ]
                          }
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "661db595-2242-4755-94ae-24908be07b37"
                      },
                      "runAfter": {
                        "lastMod_from_Portal": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "lastMod_from_COE": {
                      "description": "coalesce(formatDateTime(outputs('PortalLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "inputs": "@coalesce(formatDateTime(outputs('PortalLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "metadata": {
                        "operationMetadataId": "e709cc59-c128-436c-8d06-d6ea117c9379"
                      },
                      "runAfter": {},
                      "type": "Compose"
                    },
                    "lastMod_from_Portal": {
                      "description": "formatDateTime(body('Parse_Portals_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "inputs": "@formatDateTime(body('Parse_Portals_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "metadata": {
                        "operationMetadataId": "97cf8b35-87c6-4046-a8ff-01ca73e4abe8"
                      },
                      "runAfter": {
                        "lastMod_from_COE": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    }
                  },
                  "else": {
                    "actions": {
                      "Check_to_see_if_made_by_system_(owner_=_system)": {
                        "actions": {
                          "Create_New_Portal_Record_(Created_By_System)": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps_1",
                                "operationId": "CreateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_portals",
                                "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                "item/admin_appownerdisplayname": "SYSTEM",
                                "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                "item/admin_authlocalregistrationenabled": "@outputs('Auth_Local_Registration_Enabled')",
                                "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                "item/admin_hasportalmanagementapp": true,
                                "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                "item/admin_portalisophaned": false,
                                "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "6a823a82-75e9-473d-9a89-dbd8e817af77"
                            },
                            "runAfter": {
                              "This_means_it_was_system_created_and_automated": [
                                "Succeeded"
                              ]
                            },
                            "type": "OpenApiConnection"
                          },
                          "This_means_it_was_system_created_and_automated": {
                            "description": "System Created Path Block",
                            "inputs": "systemcreated",
                            "metadata": {
                              "operationMetadataId": "0612306f-07f1-48ce-8a6a-b63550a557c9"
                            },
                            "runAfter": {},
                            "type": "Compose"
                          }
                        },
                        "else": {
                          "actions": {
                            "Insert_based_on_orphan_status": {
                              "actions": {
                                "Insert_Portal_Website_": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps_1",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_portals",
                                      "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                      "item/admin_PortalOwner@odata.bind": "admin_makers(@{body('Maker_Check_-_New')?['userid']})",
                                      "item/admin_appownerdisplayname": "@body('Maker_Check_-_New')?['userdisplayname']",
                                      "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                      "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                      "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                      "item/admin_authlocalregistrationenabled": "@outputs('Auth_Local_Registration_Enabled')",
                                      "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                      "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                      "item/admin_hasportalmanagementapp": true,
                                      "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                      "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                      "item/admin_portalisophaned": false,
                                      "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                      "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                      "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                      "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                      "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                      "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                      "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                      "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')"
                                    },
                                    "retryPolicy": {
                                      "count": 10,
                                      "interval": "PT10S",
                                      "type": "exponential"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "19f76668-46fa-4462-9ac0-e523111c82d2"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "description": "Add the portal to the inventory either with owner info or as an orphaned portal",
                              "else": {
                                "actions": {
                                  "Insert_Portal_Website": {
                                    "description": "Abandoned",
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps_1",
                                        "operationId": "CreateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_portals",
                                        "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                        "item/admin_authexternalidentitiesenabled": "@outputs('Auth_External_Identities_Enabled')",
                                        "item/admin_authinvitationenabled": "@outputs('Auth_Invitation_Enabled')",
                                        "item/admin_authlocalauthenticationenabled": "@outputs('Auth_Local_Authentication_Enabled')",
                                        "item/admin_authlocalregistrationenabled": "@outputs('Auth_Local_Registration_Enabled')",
                                        "item/admin_authopenregistrationenabled": "@outputs('Auth_Open_Registration_Enabled')",
                                        "item/admin_authtablepermissionsenabled": "@outputs('All_Table_Permissions_Enbabled')",
                                        "item/admin_hasportalmanagementapp": true,
                                        "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                        "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                        "item/admin_portalisophaned": true,
                                        "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                        "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                        "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                        "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                        "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                        "item/admin_tablepermissionsenabledalladvformstep": "@variables('AdvancedFormStepHasTablePermissionsEnabled')",
                                        "item/admin_tablepermissionsenabledallbasicforms": "@outputs('Basic_Form_Table_Permission_Enabled_Value_')",
                                        "item/admin_tablepermissionsenabledalllists": "@outputs('Entity_List_Table_Permission_Enabled_Value')"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "4cc0aa37-cdd2-430d-92f0-96b37f5a88d6"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "7d7ed0d5-4ecf-4778-8821-bb5d5c4ec08e"
                              },
                              "runAfter": {
                                "Recheck_Orphan_status_new": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "Recheck_Orphan_status_new": {
                              "actions": {
                                "Check_if_Orphan_-_New": {
                                  "actions": {
                                    "Set_isOrphaned_true": {
                                      "inputs": {
                                        "name": "isOrphaned",
                                        "value": "@true"
                                      },
                                      "metadata": {
                                        "operationMetadataId": "898b84f5-a0c0-47bb-a493-43dd2a47f636"
                                      },
                                      "runAfter": {},
                                      "type": "SetVariable"
                                    }
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_isOrphaned_false": {
                                        "inputs": {
                                          "name": "isOrphaned",
                                          "value": "@false"
                                        },
                                        "metadata": {
                                          "operationMetadataId": "1ef2837d-b199-4972-85ad-d543cadde4d2"
                                        },
                                        "runAfter": {},
                                        "type": "SetVariable"
                                      }
                                    }
                                  },
                                  "expression": {
                                    "equals": [
                                      "@body('Maker_Check_-_New')?['userisorphan']",
                                      "@true"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "abfefac0-d5d0-4abe-a052-c7becee2344f"
                                  },
                                  "runAfter": {
                                    "Maker_Check_-_New": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "If"
                                },
                                "Maker_Check_-_New": {
                                  "inputs": {
                                    "body": {
                                      "boolean": false,
                                      "text": "@if(equals(body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid'], null), '', body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid'])",
                                      "text_1": "@body('Get_ADX_Website_Owner')?['fullname']"
                                    },
                                    "host": {
                                      "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "73bbd222-039f-4a63-82f1-aa15576cca76"
                                  },
                                  "runAfter": {},
                                  "type": "Workflow"
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "09aa7c47-86db-4468-b151-8fa17fdaeef0"
                              },
                              "runAfter": {},
                              "type": "If"
                            }
                          }
                        },
                        "expression": {
                          "equals": [
                            "@body('Get_ADX_Website_Owner')?['fullname']",
                            "SYSTEM"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "57718201-db86-48cd-9c78-fd7a95eae470"
                        },
                        "runAfter": {
                          "isNewToCoE_=true": [
                            "Succeeded"
                          ]
                        },
                        "type": "If"
                      },
                      "isNewToCoE_=true": {
                        "description": "We know that the item is actually new to the CCOE and needs an inventory record",
                        "inputs": "@variables('isNewToCoE')",
                        "metadata": {
                          "operationMetadataId": "e76a341d-d38b-44be-a75e-90109f17fb40"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('isNewToCoE')",
                      "@false"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "82541716-537e-4980-a709-c69972b41e8d"
                  },
                  "runAfter": {
                    "If_did_not_return_rows_then_new_to_Coe_else_get_portal_GUID": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "Site_Settings_Filtering_for_Authentication_Types": {
                  "actions": {
                    "Auth_External_Identities_Enabled": {
                      "description": "if filter returned no rows, default to true, else get value",
                      "inputs": "@if(equals(length(body('Filter_Array:_Return_External_Identities_Enabled_Site_Setting')), 0), true, First(body('Filter_array:_Return_External_Identities_Enabled_Site_Setting'))['adx_value'])",
                      "metadata": {
                        "operationMetadataId": "fa6b3a02-12a6-4e45-ad82-8c6732dfc0ae"
                      },
                      "runAfter": {
                        "Filter_Array:_Return_External_Identities_Enabled_Site_Setting": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Auth_Invitation_Enabled": {
                      "description": "if filter returned no rows, default to true, else get value",
                      "inputs": "@if(equals(length(body('Filter_Array:_Return_Invitation_Enabled_Site_Setting')), 0), true, First(body('Filter_array:_Return_Invitation_Enabled_Site_Setting'))['adx_value'])",
                      "metadata": {
                        "operationMetadataId": "a7097c18-739c-4ffe-a566-d8808c445c2a"
                      },
                      "runAfter": {
                        "Filter_Array:_Return_Invitation_Enabled_Site_Setting": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Auth_Local_Authentication_Enabled": {
                      "description": "if filter returned no rows, default to true, else get value",
                      "inputs": "@if(equals(length(body('Filter_array:_Return_Local_Auth_Site_Setting')), 0), true, First(body('Filter_array:_Return_Local_Auth_Site_Setting'))['adx_value'])",
                      "metadata": {
                        "operationMetadataId": "c830a6dc-adb0-4362-bfa6-51b5f76ead69"
                      },
                      "runAfter": {
                        "Filter_array:_Return_Local_Auth_Site_Setting": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Auth_Local_Registration_Enabled": {
                      "description": "if filter returned no rows, default to true, else get value",
                      "inputs": "@if(equals(length(body('Filter_Array:_Return_Local_Registration_Enabled_Site_Setting')), 0), true, First(body('Filter_array:_Return_Local_Registration_Enabled_Site_Setting'))['adx_value'])",
                      "metadata": {
                        "operationMetadataId": "6e8a1960-5207-49fa-b47f-b9e6f6b2b7aa"
                      },
                      "runAfter": {
                        "Filter_Array:_Return_Local_Registration_Enabled_Site_Setting": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Auth_Open_Registration_Enabled": {
                      "description": "if filter returned no rows, default to true, else get value",
                      "inputs": "@if(equals(length(body('Filter_array:_Return_Open_Registration_Enabled_Site_Setting')), 0), true, First(body('Filter_array:_Return_Open_Registration_Enabled_Site_Setting'))['adx_value'])",
                      "metadata": {
                        "operationMetadataId": "1e351ecc-8fb6-4003-a92a-53283faaf455"
                      },
                      "runAfter": {
                        "Filter_array:_Return_Open_Registration_Enabled_Site_Setting": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Filter_Array:_Return_External_Identities_Enabled_Site_Setting": {
                      "inputs": {
                        "from": "@outputs('List_Related_Site_Settings_to_the_portal')?['body/value']",
                        "where": "@equals(item()?['adx_name'], 'Authentication/Registration/ExternalLoginEnabled')"
                      },
                      "metadata": {
                        "operationMetadataId": "55402c9f-bf7b-4b6f-978d-057a1b9987d2"
                      },
                      "runAfter": {
                        "Auth_Invitation_Enabled": [
                          "Succeeded"
                        ]
                      },
                      "type": "Query"
                    },
                    "Filter_Array:_Return_Invitation_Enabled_Site_Setting": {
                      "inputs": {
                        "from": "@outputs('List_Related_Site_Settings_to_the_portal')?['body/value']",
                        "where": "@equals(item()?['adx_name'], 'Authentication/Registration/InvitationEnabled')"
                      },
                      "metadata": {
                        "operationMetadataId": "a73d4afd-c62c-4e67-8a01-8665998c19e4"
                      },
                      "runAfter": {
                        "Auth_Local_Registration_Enabled": [
                          "Succeeded"
                        ]
                      },
                      "type": "Query"
                    },
                    "Filter_Array:_Return_Local_Registration_Enabled_Site_Setting": {
                      "inputs": {
                        "from": "@outputs('List_Related_Site_Settings_to_the_portal')?['body/value']",
                        "where": "@equals(item()?['adx_name'], 'Authentication/Registration/Enabled')"
                      },
                      "metadata": {
                        "operationMetadataId": "64aac7ba-017e-4a44-a1a6-490befb619bc"
                      },
                      "runAfter": {
                        "Auth_Open_Registration_Enabled": [
                          "Succeeded"
                        ]
                      },
                      "type": "Query"
                    },
                    "Filter_array:_Return_Local_Auth_Site_Setting": {
                      "inputs": {
                        "from": "@outputs('List_Related_Site_Settings_to_the_portal')?['body/value']",
                        "where": "@equals(item()?['adx_name'], 'Authentication/Registration/LocalLoginEnabled')"
                      },
                      "metadata": {
                        "operationMetadataId": "22188e6b-29ee-4fc9-b2c1-d4825e46b321"
                      },
                      "runAfter": {},
                      "type": "Query"
                    },
                    "Filter_array:_Return_Open_Registration_Enabled_Site_Setting": {
                      "inputs": {
                        "from": "@outputs('List_Related_Site_Settings_to_the_portal')?['body/value']",
                        "where": "@equals(item()?['adx_name'], 'Authentication/Registration/OpenRegistrationEnabled')"
                      },
                      "metadata": {
                        "operationMetadataId": "b8a3c950-dcee-46b9-b575-b9ff00f3902f"
                      },
                      "runAfter": {
                        "Auth_Local_Authentication_Enabled": [
                          "Succeeded"
                        ]
                      },
                      "type": "Query"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "47dcad0d-846a-4d7c-a3f3-1dc410155566"
                  },
                  "runAfter": {
                    "List_Related_Site_Settings_to_the_portal": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "UniqueNameString": {
                  "description": "concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Portals_JSON')?['adx_websiteid'])",
                  "inputs": "@concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Portals_JSON')?['adx_websiteid'])",
                  "metadata": {
                    "operationMetadataId": "bedd1a98-ae0c-4844-958d-351eb824be45"
                  },
                  "runAfter": {
                    "Data_Security_": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                }
              },
              "foreach": "@outputs('List_ADX_Websites')?['body/value']",
              "metadata": {
                "operationMetadataId": "85ba42d4-dec1-4f65-b8db-720df51cb994"
              },
              "runAfter": {
                "Remove_the_GUID_without_the_prefixes_from_using_old_connector": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Name_Length": {
              "description": "Return index where GUID value starts",
              "inputs": "@sub(length(body('Get_Environment_as_Admin')?['name']), 36)",
              "metadata": {
                "operationMetadataId": "8308402d-4e68-4804-914f-95f805e000e0"
              },
              "runAfter": {
                "Get_Environment_as_Admin": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Remove_the_GUID_without_the_prefixes_from_using_old_connector": {
              "inputs": "@substring(body('Get_Environment_as_Admin')?['name'], int(outputs('Name_Length')), 36)",
              "metadata": {
                "operationMetadataId": "0dbf8c3d-65b0-4fce-a54d-25715f4c2555"
              },
              "runAfter": {
                "Name_Length": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            }
          },
          "metadata": {
            "operationMetadataId": "951719a3-92b2-4715-8b60-9beb16856c7b"
          },
          "runAfter": {
            "Initialize_variable_AdvancedFormStepHasTablePermissionsEnabled": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Clean_up_Envt_-_GitHub_1096": {
          "actions": {
            "Delete_all_portals_-_clean_up": {
              "actions": {
                "Delete_a_row_-_clean_up": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "DeleteRecord"
                    },
                    "parameters": {
                      "entityName": "admin_portals",
                      "recordId": "@items('Delete_all_portals_-_clean_up')?['admin_portalid']"
                    },
                    "retryPolicy": {
                      "count": 10,
                      "interval": "PT10S",
                      "type": "exponential"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "c0a5761f-f07e-418f-89ec-eaf97259abb6"
                  },
                  "runAfter": {},
                  "type": "OpenApiConnection"
                }
              },
              "foreach": "@outputs('List_portals_for_this_envt_-_clean_up')?['body/value']",
              "metadata": {
                "operationMetadataId": "be8b419a-0998-4da8-b975-2a67dede31a4"
              },
              "runAfter": {
                "List_portals_for_this_envt_-_clean_up": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "List_portals_for_this_envt_-_clean_up": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$filter": "admin_portaluniquename eq null and _admin_portalenvironment_value eq '@{triggerOutputs()?['body/admin_environmentid']}'",
                  "$select": "admin_portalid",
                  "entityName": "admin_portals"
                }
              },
              "metadata": {
                "operationMetadataId": "bb58a376-a4e6-4950-9c27-ad578ee6a76e"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 5000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "description": "Scope added to clean up duplicate records as we changed GUID scheme. Will delete this scope in a few months after repair is complete. ",
          "metadata": {
            "operationMetadataId": "5376a089-b587-439a-8f04-af92b9fc6cb1"
          },
          "runAfter": {
            "Get_ADX_Websites._Terminate_if_no_portals": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_ADX_Websites._Terminate_if_no_portals": {
          "actions": {
            "List_ADX_Websites": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                  "connectionName": "shared_commondataservice_3",
                  "operationId": "GetItems_V2"
                },
                "parameters": {
                  "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                  "table": "adx_websites"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "f2d83285-6028-442d-a929-e86419daee5b"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 5000
                }
              },
              "type": "OpenApiConnection"
            },
            "Terminate_if_no_portals": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "c8835cdf-694e-406a-98d7-9d1210bce72e"
              },
              "runAfter": {
                "List_ADX_Websites": [
                  "Failed",
                  "TimedOut"
                ]
              },
              "type": "Terminate"
            }
          },
          "metadata": {
            "operationMetadataId": "ae87a47e-c0e0-4ced-964e-e8d30a5b8d55"
          },
          "runAfter": {
            "Check_if_Teams_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_Portals_Fails_-_Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "CreateRecord"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_environmentname": "@triggerOutputs()?['body/admin_displayname']",
                  "item/admin_flowinstanceurl": "@concat(variables('flowEnvironment'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])",
                  "item/admin_name": "Admin | Sync Template v3 (Portals)"
                }
              },
              "metadata": {
                "operationMetadataId": "481357cb-2e63-49f4-8066-6c2fee35c5ac"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Terminate_": {
              "inputs": {
                "runError": {
                  "code": "500",
                  "message": "Get Model Portals Failed"
                },
                "runStatus": "Failed"
              },
              "metadata": {
                "operationMetadataId": "de76591a-2250-486e-b38e-c6926762bb0b"
              },
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "type": "Terminate"
            }
          },
          "metadata": {
            "operationMetadataId": "2c7e9d64-1478-4811-895e-ca2e72d10a2a"
          },
          "runAfter": {
            "Check_to_see_if_portal_Model_Driven_App_Exists._Store_in_Portal_COE_Entity": [
              "Failed",
              "TimedOut"
            ]
          },
          "type": "Scope"
        },
        "Initialize_variable_AdvancedFormStepHasTablePermissionsEnabled": {
          "description": "initialize to true meaning all steps have table permissions enabled",
          "inputs": {
            "variables": [
              {
                "name": "AdvancedFormStepHasTablePermissionsEnabled",
                "type": "boolean",
                "value": "@true"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "f1abf91d-ebd9-46e4-abc3-cb6a7ee3350e"
          },
          "runAfter": {
            "Initialize_variable_fullInventory": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_flowEnvironment": {
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "0e3aded1-e12f-4727-9994-66615d01e724"
          },
          "runAfter": {
            "Initialize_variable_isOrphaned": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_fullInventory": {
          "inputs": {
            "variables": [
              {
                "name": "fullInventory",
                "type": "string",
                "value": "@{parameters('FullInventory (admin_FullInventory)')}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "a280799e-da4b-4150-ba89-2617d3f67cf7"
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isNewToCoE": {
          "inputs": {
            "variables": [
              {
                "name": "isNewToCoE",
                "type": "boolean",
                "value": false
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "fa0828b7-450c-4f8b-82bb-e314a8e14249"
          },
          "runAfter": {
            "Clean_up_Envt_-_GitHub_1096": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isOrphaned": {
          "inputs": {
            "variables": [
              {
                "name": "isOrphaned",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "9b6ae97d-cc02-44e3-af1c-85bd12844727"
          },
          "runAfter": {
            "Initialize_variable_today": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_today": {
          "inputs": {
            "variables": [
              {
                "name": "today",
                "type": "string",
                "value": "@{utcNow()}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "f234c33d-3902-4a5b-b0ba-7e8f1c5f361d"
          },
          "runAfter": {
            "Initialize_variable_isNewToCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "FullInventory (admin_FullInventory)": {
          "defaultValue": true,
          "metadata": {
            "description": "Determines if you want to only update objects that have changed, or all objects. Defaults to No. Switching to Yes will cause the flows to inventory every single app/flow/etc in the tenant and make the flows long running ",
            "schemaName": "admin_FullInventory"
          },
          "type": "Bool"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://us.flow.microsoft.com/manage/environments/",
          "metadata": {
            "description": "Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/",
            "schemaName": "admin_PowerAutomateEnvironmentVariable"
          },
          "type": "String"
        }
      },
      "triggers": {
        "When_a_new_record_is_created_or_updated": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps_1",
              "operationId": "SubscribeWebhookTrigger"
            },
            "parameters": {
              "subscriptionRequest/entityname": "admin_environment",
              "subscriptionRequest/message": 4,
              "subscriptionRequest/scope": 4
            }
          },
          "metadata": {
            "operationMetadataId": "83945f27-631b-49ab-8aa8-9e38801fae64"
          },
          "type": "OpenApiConnectionWebhook"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
